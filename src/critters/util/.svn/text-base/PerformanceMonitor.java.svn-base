/*
 * Created on Jul 30, 2009
 */
package critters.util;

import java.lang.management.ManagementFactory;

import com.sun.management.OperatingSystemMXBean;

public class PerformanceMonitor {
	private int availableProcessors = 1;
	private long lastSystemTime = 0;
	private long lastProcessCpuTime = 0;
	private OperatingSystemMXBean osBean;
	private volatile static PerformanceMonitor monitor = null;

	private PerformanceMonitor() {
		osBean = (OperatingSystemMXBean) ManagementFactory
				.getOperatingSystemMXBean();

		availableProcessors = osBean.getAvailableProcessors();
	}

	public static PerformanceMonitor getInstance() {
		if (monitor == null) {
			synchronized (PerformanceMonitor.class) {
				monitor = new PerformanceMonitor();
			}
		}

		return monitor;
	}

	public synchronized double getCpuUsage() {
		if (lastSystemTime == 0) {
			baselineCounters();
			return 0.0;
		}

		long systemTime = System.nanoTime();
		long processCpuTime = 0;

		processCpuTime = osBean.getProcessCpuTime();

		double cpuUsage = (double) (processCpuTime - lastProcessCpuTime)
				/ (systemTime - lastSystemTime);

		lastSystemTime = systemTime;
		lastProcessCpuTime = processCpuTime;

		return cpuUsage;
	}

	private void baselineCounters() {
		lastSystemTime = System.nanoTime();

		lastProcessCpuTime = osBean.getProcessCpuTime();
	}
	
	public static void main(String[] args) throws InterruptedException
	{
		while(true)
		{
			System.out.printf("cpu=%.4f\n", (PerformanceMonitor.getInstance().getCpuUsage() * 100.0));
			Thread.sleep(1000);
		}
	}
}

